# ================================================
# CD Pipeline â€” Deploy to Render
# ================================================
# Triggers a deploy on Render after CI passes.
# Render builds the Docker image from this repo
# and deploys it automatically.
#
# Required GitHub Secrets:
#   - RENDER_DEPLOY_HOOK_URL : Render Deploy Hook URL
#     (Get it from: Render Dashboard â†’ Your Service
#      â†’ Settings â†’ Deploy Hook)
#
# How Render Deploy Works:
#   1. This workflow hits the Render Deploy Hook URL
#   2. Render pulls the latest code from the repo
#   3. Render builds the Docker image using Dockerfile
#   4. Render deploys the new container
#   5. Health checks verify the deployment
#
# Environment variables (DATABASE_URL, SECRET_KEY,
# MOODLE_BASE_URL, etc.) are configured directly
# in the Render dashboard, NOT in this file.
# ================================================

name: Deploy to Render

on:
  push:
    branches: [main]

  # Allow manual deployment from GitHub Actions tab
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Run CI first (reuse the CI workflow)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: âœ… Run CI Checks
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Deploy to Render (only after CI passes)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://lms-sae.onrender.com

    steps:
      - name: Trigger Render Deploy
        run: |
          echo "ğŸš€ Triggering deploy on Render..."
          RESPONSE=$(curl -sf -o /dev/null -w "%{http_code}" \
            "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "âœ… Deploy triggered successfully (HTTP $RESPONSE)"
            echo ""
            echo "ğŸ“‹ Render will now:"
            echo "   1. Pull latest code from main branch"
            echo "   2. Build Docker image"
            echo "   3. Deploy new container"
            echo "   4. Run health checks"
            echo ""
            echo "ğŸ”— Monitor at: https://dashboard.render.com"
          else
            echo "âŒ Failed to trigger deploy (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Wait for deployment
        run: |
          echo "â³ Waiting 60s for Render to start building..."
          sleep 60
          echo "âœ… Deploy should be in progress on Render."
          echo "   Check https://dashboard.render.com for status."
