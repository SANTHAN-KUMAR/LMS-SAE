name: CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./exam_middleware

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Explicitly install packages that might be missing or platform-specific replacements
          pip install aiosqlite python-magic

      - name: Run Tests
        env:
          TESTING: "true"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          SECRET_KEY: "test-secret"
          PYTHONPATH: ${{ github.workspace }}/exam_middleware
        run: |
          pytest -v -m "unit or not (integration or e2e)" tests/unit/

  # ============================================
  # REAL DATABASE INTEGRATION TEST
  # ============================================
  # Tests against your ACTUAL Neon DB to catch connection issues
  # (like sslmode crashes) BEFORE they reach production.
  # 
  # Required GitHub Secrets:
  #   - DATABASE_URL: Your Neon connection string
  #   - SECRET_KEY: Your app's secret key
  # ============================================
  integration-test:
    name: Real DB Integration Test
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Dependencies
        working-directory: ./exam_middleware
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test Real Database Connection
        working-directory: ./exam_middleware
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          TESTING: "false"
          PYTHONPATH: ${{ github.workspace }}/exam_middleware
        run: |
          echo "ðŸ”Œ Testing connection to production Neon DB..."
          python -c "
          import asyncio
          from app.db.database import engine
          from sqlalchemy import text

          async def test_connection():
              print('Connecting to database...')
              async with engine.begin() as conn:
                  result = await conn.execute(text('SELECT 1'))
                  print('âœ… Database connection successful!')
                  
                  # Test table access
                  tables = await conn.execute(text(
                      \"SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'\"
                  ))
                  table_list = [row[0] for row in tables]
                  print(f'âœ… Found {len(table_list)} tables: {table_list}')
              
              await engine.dispose()
              print('âœ… All integration tests passed!')

          asyncio.run(test_connection())
          "

      - name: Build Docker Image
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t exam-app-test .

      - name: Test Container Boot with Real DB
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          echo "ðŸš€ Starting container with real Neon DB..."
          docker run -d --name exam-test \
            -e DATABASE_URL="${DATABASE_URL}" \
            -e SECRET_KEY="${SECRET_KEY}" \
            -e DEBUG=false \
            -e MOODLE_BASE_URL=http://localhost \
            -p 8000:8000 \
            exam-app-test
          
          echo "â³ Waiting for app to start (30s max)..."
          sleep 10
          
          # Check if container is still running
          if [ "$(docker inspect -f '{{.State.Running}}' exam-test)" != "true" ]; then
            echo "âŒ Container crashed!"
            docker logs exam-test
            exit 1
          fi
          
          echo "âœ… Container is running!"
          
          # Test health endpoint
          echo "ðŸ¥ Testing health endpoint..."
          HEALTH_RESPONSE=$(docker exec exam-test curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/health || echo "failed")
          
          if [ "$HEALTH_RESPONSE" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âš ï¸ Health check returned: $HEALTH_RESPONSE (may still be starting)"
            docker logs exam-test --tail 50
          fi

      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "=== CONTAINER LOGS ==="
          docker logs exam-test 2>&1 || echo "No container logs available"

      - name: Cleanup
        if: always()
        run: |
          docker stop exam-test 2>/dev/null || true
          docker rm exam-test 2>/dev/null || true

